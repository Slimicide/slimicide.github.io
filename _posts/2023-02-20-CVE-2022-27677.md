---
title: CVE-2022-27677 - Low-hanging SYSTEM shells
date: 2023-02-20 12:00:00
categories: [Research, Windows]
tags: [windows, cve, privilege-escalation]     # TAG names should always be lowercase
img_path: /assets/img/Other/CVE-2022-27677
---

As an enthusiast for all things offensive security for the last almost two years, I decided it was high time I stopped reading
about other people's interesting CVEs and instead go and find my own. When choosing a target I decided I wanted it to be in an
application I actually used, not a XSS in some obscure piece of software somewhere in the depths of the internet. As a big fan
of the Ryzen line of CPUs and occasional overclocker, I saw Ryzen Master sitting on my file system and decided to get to work.

Something I was not expecting however, was articles coming out on the bug after its disclosure from the likes of [DigitalTrends](https://www.digitaltrends.com/computing/amd-ryzen-master-vulnerability-patch/)
and [Tom's Hardware](https://www.tomshardware.com/news/amds-ryzen-master-has-a-high-severity-vulnerability-patch-available) among others.
These publications don't focus exclusively on security and so the nature of certain particular bugs might not be fully understood
by their readers and in turn, might cause a bit of a panic to other users of Ryzen Master learning about a vulnerability within
software installed on their PC.

For this reason, I've decided to write this up in a manner accessible to all audiences to understand exactly what's happening here.

If you aren't interested in the detail, here's the long story short:

In cases where Ryzen Master is installed within a folder that has insecure permissions, the Ryzen Master folder inherits those
permissions leaving the contents within vulnerable to being overwritten and tampered with by a low-privileged user. In order for
this bug to be exploited, your system must have already been compromised by an attacker. This bug simply allows them to escalate
to a user even more powerful than the system's administrator.

For everyone else, here is CVE-2022-27677.

# Discovery
---
Going into this, it's hard to shake the assumption that the easy, low-hanging bugs are all gone depsite knowing this isn't the case.
Anyway, I decided to begin by capturing the install / uninstall flow using ProcMon, particularly what the `NT AUTHORITY\SYSTEM`
user is doing during this process considering it was privilege escalation I was after. The `NT AUTHORITY\SYSTEM` user is present
on all Windows machines and is reserved by Windows to conduct high-privilege operations on the machine. This `SYSTEM` user is
the most powerful user in the Windows userland second only maybe to `NT Service\TrustedInstaller` and so it is a good target
to try and escalate to.

By default, Ryzen Master will install to `C:\Program Files\AMD\RyzenMaster`. 

![Default Install](default_install.png)
_Default Install Location_

By following through with the installer in its default configuration, this was my first encounter with `DriverUtility.bat`, 
watching it zip past the ProcMon feed as it was briefly interacted with, among other things by the SYSTEM user.

In Windows, a `.bat` file is simply a list of CMD commands which, when run, will all execute sequentially. In this instance,
the `.bat` file was executed by the SYSTEM user meaning those commands are all running with the permissions afforded to them by
that user.

I decided to check the installed folder permissions to see if tampering was possible. If I could edit that `.bat` file, I could decide
what commands I wanted the SYSTEM user to run, effectively making me that user. The catch is in order for it to be a valid
vulnerability, I not only need to tamper with it, but I need to tamper with it as a low-privileged user, hence the name 
"Privilege Escalation".

![Inherited Permissions](inherited_permissions_default.png)
_Inherited Permissions_

The only group our low-privileged user falls into here is `Users` which have `Read & execute` permissions. No good for tampering.
This does however mention that these permissions are simply inherited from its parent folder `C:\Program Files`. During installation,
Ryzen Master allows the user to choose a custom install path. I can't imagine it'll still inherit permissions from that secure location
if it is no longer installed within it. I uninstalled Ryzen Master and started back up the installer except this time, I was
going to make a change.

![Custom Install](custom_install.png)
_Custom Install Location_

To my knowledge, this location could be anywhere a low-privileged user would have write access to. `C:\` was just the obvious
choice because the `Authenticated Users` group has `Modify` permissions there for `Subfolders and files only` which is just enough
for us to make some changes. Ryzen Master goes through its normal install flow, again watching the SYSTEM user interact with
`DriverUtility.bat`.

![DriverUtility.bat](procmon.png)
_Process Monitor_

There are of course other `.bat` files being interacted with here, but I only needed the one.
Once the installation was complete, I again went to check the permissions on my newest installation

![Inherited Permissions](inherited_permissions_custom.png)
_Modify_

There it is, the custom installation inherits its folder's permissions from an insecure location leaving its contents vulnerable.

# Exploitation
---
Now that we have the means to overwrite the file, it's as easy as verifying we have execution as the `NT AUTHORITY\SYSTEM` user. 
A simple PoC I went with is writing the output of `whoami` to a file. Ryzen Master executes `DriverUtility.bat` on three 
occasions (that I know about): It executes on install, uninstall, and update.

![PoC Setup](poc_setup.png)
_whoami_

Now, upon the uninstallation of Ryzen Master, the contents of `DriverUtility.bat` should be executed as `NT AUTHORITY\SYSTEM`
and as proof here is the resulting text file generated by my overwritten command.

![PoC Fired](poc_fired.png)
_NT AUTHORITY\SYSTEM_

The impact here is pretty clear, complete command-line access to the machine as one of the most powerful users on Windows,
backdoor accounts can be created, private information can be accessed and exfiltrated, but just for fun we can leverage 
`netcat` to send a SYSTEM shell to a remote machine for a more interactive method of leveraging our new-found power over the machine.

![System Shell](system_shell.png)
_SYSTEM Shell_

There it is. That's the bug. There's no flashy ROP chains or memory corruption, there's no high-octane exploitation of the CPU 
itself, it's a simple Windows Privilege Escalation bug caused by Ryzen Master trusting insecure directories and inheriting their
permissions while having critical installation files inside.

Get the most up-to-date Ryzen Master build from [here](https://www.amd.com/en/technologies/ryzen-master)

# :)
