<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HackTheBox - Intelligence" /><meta property="og:locale" content="en" /><meta name="description" content="HackTheBox Intelligence" /><meta property="og:description" content="HackTheBox Intelligence" /><link rel="canonical" href="https://slimicide.github.io/posts/HackTheBox-Intelligence/" /><meta property="og:url" content="https://slimicide.github.io/posts/HackTheBox-Intelligence/" /><meta property="og:site_name" content="Slimicide" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-05T17:30:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox - Intelligence" /><meta name="twitter:site" content="@Slimicide_" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-05T17:30:00+00:00","datePublished":"2022-05-05T17:30:00+00:00","description":"HackTheBox Intelligence","headline":"HackTheBox - Intelligence","mainEntityOfPage":{"@type":"WebPage","@id":"https://slimicide.github.io/posts/HackTheBox-Intelligence/"},"url":"https://slimicide.github.io/posts/HackTheBox-Intelligence/"}</script><title>HackTheBox - Intelligence | Slimicide</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Slimicide"><meta name="application-name" content="Slimicide"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /avatar.PNG " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Slimicide</a></div><div class="site-subtitle font-italic">Learning to break things responsibly. Writeups 'n Stuff.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Slimicide" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Slimicide_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox - Intelligence</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox - Intelligence</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Slimicide_">Slimicide</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1651771800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-05 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1708 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_intelligence.png" alt="Intelligence" title="Intelligence" data-proofer-ignore> <em>HackTheBox Intelligence</em></p><p><strong>Intelligence</strong> is a retired medium <strong>Active Directory</strong> machine on HackTheBox, this machine was my first real dive into Active Directory exploitation and it was the perfect machine to do it with, I had a lot of fun working through this one.</p><hr /><h1 id="enumeration">Enumeration</h1><p>Active Directory machines have a <strong>lot</strong> of ports open on them. We can just do a thorough scan of the results of:<br /> <code class="language-plaintext highlighter-rouge">nmap -p- 10.10.10.248</code><br /></p><p><strong>Scan:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p</span> 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389 <span class="nt">-oA</span> nmap 10.10.10.248
</pre></table></code></div></div><p><strong>Results:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre>Nmap scan report for 10.10.10.248
Host is up (0.044s latency).
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Intelligence
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-04-10 23:27:52Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2022-04-10T23:29:21+00:00; +7h00m02s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2022-04-10T23:29:21+00:00; +7h00m03s from scanner time.
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2022-04-10T23:29:21+00:00; +7h00m02s from scanner time.
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2022-04-10T23:29:21+00:00; +7h00m03s from scanner time.
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
</pre></table></code></div></div><p>We have our hostname of <code class="language-plaintext highlighter-rouge">intelligence.htb</code>, we can add that to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> and continue on to Port 80.</p><hr /><h1 id="port-80">Port 80</h1><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_landingpage.png" alt="Landing Page" title="Landing Page" data-proofer-ignore> <em>http://intelligence.htb/</em></p><p>This page is very simple, there isn’t a whole lot going on. Scrolling down on the landing page, there are two PDF files available for download.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_documentdownload.png" alt="Documents" title="Documents" data-proofer-ignore> <em>http://intelligence.htb/</em></p><p>These documents listed for download are simply just full of <a href="https://en.wikipedia.org/wiki/Lorem_ipsum">Lorem Ipsum</a>. The naming convention of these files however are far more interesting: <code class="language-plaintext highlighter-rouge">YYYY-MM-DD-upload.pdf</code><br /><br /></p><p>We can scan for that, but before we do, we should make sure these documents are definitely useless by extracting their metadata using a tool called <code class="language-plaintext highlighter-rouge">exiftool</code>.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_exiftool.png" alt="Exiftool" title="Exiftool" data-proofer-ignore> <em>exiftool 2020-01-01-upload.pdf</em></p><p>Good thing we checked, we are given a username in the <code class="language-plaintext highlighter-rouge">Creator</code> field that we can assume to be Active Directory usernames. We have our first one, <code class="language-plaintext highlighter-rouge">William.Lee</code>. Now we have a clear goal in mind.<br /></p><ul><li>Generate a list of possible filenames using the naming convention discovered above,<br /><li>Fuzz the server for them,<br /><li>Download the ones that exist,<br /><li>Extract their creators,<br /><li>Scan all the documents for keywords because there’s no way they’re all just Lorem Ipsum.<br /></ul><p>First off, generating the list of possible filenames. <img data-src="/assets/img/HackTheBox/Intelligence/htb_docscript.png" alt="Script" title="Document Script" data-proofer-ignore> <em>dateGen.py</em></p><p>I am far from proud of this script and there is certainly a far better way but hey, it works and I’m already finished with it. We’re left with a file full of all the possible names for files on the server. (I also checked 2019 and 2021; nothing there.)</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_documentlist.png" alt="Documents" title="Document List" data-proofer-ignore> <em>PDF Fuzzing List</em></p><p>Writing this up, I’ve just realized my script missed <code class="language-plaintext highlighter-rouge">2020-01-10</code> and presumably others. Serves me right for writing that abomination. Good thing I didn’t need them. Anyway, with this list, we can find what files are hiding on the server.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_fuzzingdocs.png" alt="Fuzzing" title="Fuzzing Documents" data-proofer-ignore> <em>Fuzzing Documents</em></p><p><code class="language-plaintext highlighter-rouge">wfuzz</code> did not want to give me a list I could use, so I can just copy the output and use <code class="language-plaintext highlighter-rouge">awk</code> to liberate the filenames into a format I can actually use.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_founddocs.png" alt="awk" title="awk" data-proofer-ignore> <em>Bash Magic</em></p><p>Now that we have a list of real PDFs, we can use another Bash one-liner to fetch all of them.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_wget.png" alt="wget" title="wget" data-proofer-ignore> <img data-src="/assets/img/HackTheBox/Intelligence/htb_pdfs.png" alt="79 PDFs" title="79 PDFs" data-proofer-ignore></p><p>Now that we’ve retrieved all of our PDFs we can harvest the names of all their creators to use for later spraying.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_users.png" alt="User Harvesting" title="User Harvesting" data-proofer-ignore> <img data-src="/assets/img/HackTheBox/Intelligence/htb_userlist.png" alt="User List" title="User List" data-proofer-ignore> <em>79 Creators Harvested</em></p><p>Some of these creators may appear across multiple documents and consequentially, appear multiple times in this list. For our purposes in this CTF, there’s no need to filter them out. Now that we have our usernames, we just have to scan these documents for keywords to make sure we haven’t missed anything. The documents are currently in PDF format. We need to first get them into a more friendly format to scan them, thankfully, <code class="language-plaintext highlighter-rouge">pdftotext</code> exists. <code class="language-plaintext highlighter-rouge">pdftotext</code> doesn’t seem to like multiple inputs so we can simply just Bash loop them in.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_pdftotext.png" alt="pdftotext" title="pdftotext" data-proofer-ignore> <img data-src="/assets/img/HackTheBox/Intelligence/htb_txtlist.png" alt="text list" title="text list" data-proofer-ignore> <em>79 Text Files</em></p><p>Smooth sailing from here. Simply <code class="language-plaintext highlighter-rouge">cat *</code>, pass it to grep with some keywords and see what falls on our lap.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_scandoc.png" alt="Scan Documents" title="Scan Documents" data-proofer-ignore> <em>NewIntelligenceCorpUser9876</em></p><p>There we have it. Some diamonds in the rough. We have a default domain password, an extensive list of usernames and an internal IT update we’ll see more of in the root portion of this box. Now we can get to the password-spraying. For this I like to use Metasploit, more specifically: <code class="language-plaintext highlighter-rouge">auxiliary/scanner/smb/smb_login</code>. With this module, I pass in <code class="language-plaintext highlighter-rouge">RHOSTS</code>, <code class="language-plaintext highlighter-rouge">SMBDomain</code>, <code class="language-plaintext highlighter-rouge">USER_FILE</code>, <code class="language-plaintext highlighter-rouge">PASS_FILE</code> and run the scanner.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_smbbrute.png" alt="User" title="User" data-proofer-ignore> <em>Tiffany.Molina:NewIntelligenceCorpUser9876</em></p><p>In a sea of invalid credentials, <code class="language-plaintext highlighter-rouge">Tiffany.Molina</code> is still using the default password and is our ticket into the domain.</p><hr /><h1 id="smbclient">SMBClient</h1><p>Authenticating into the SMB as <code class="language-plaintext highlighter-rouge">Tiffany.Molina</code>, we get a list of shares she has access to.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_tiffanysmb.png" alt="SMB" title="Tiffany SMB" data-proofer-ignore> <em>Tiffany - SMBClient</em></p><p>Navigating to the <code class="language-plaintext highlighter-rouge">Users</code> share, we see <code class="language-plaintext highlighter-rouge">Ted.Graves</code> who is presumably our root target and <code class="language-plaintext highlighter-rouge">Tiffany.Molina</code> who we will retrieve our user flag from. Navigate to her desktop and there it is.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_user.png" alt="User.txt" title="User.txt" data-proofer-ignore> <em>User.txt</em></p><hr /><h1 id="system">System</h1><p>This part is where things started to get a little bit confusing for me on account of being relatively new to Windows machines on HackTheBox. Despite not having the knowledge necessary to see this machine through to the end on my own, in the interest of learning how it’s done, I am using <a href="https://0xdf.gitlab.io/2021/11/27/htb-intelligence.html">oxdf’s writeup</a> of this machine as a reference to practice Active Directory exploitation.<br /><br /></p><p>Remembering back earlier, we found the <strong>Internal IT Update</strong> in the documents regarding Ted’s script. As Tiffany, we have access to the IT SMB share so we can see what it’s all about. Connecting to the IT share, we find the script referenced earlier: <code class="language-plaintext highlighter-rouge">downdetector.ps1</code></p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_founddowndetector.png" alt="Found DownDetector.ps1" title="Found DownDetector.ps1" data-proofer-ignore></p><p>Downloading <code class="language-plaintext highlighter-rouge">DownDetector.ps1</code>, it’s relatively easy to decipher what it’s doing.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_downdetector.png" alt="DownDetector.ps1" title="DownDetector.ps1" data-proofer-ignore> <em>DownDetector.ps1</em></p><p>This script:</p><ul><li>Fetches every domain object beginning with <code class="language-plaintext highlighter-rouge">web*</code>,<li>Makes a web request to each domain object beginning with <code class="language-plaintext highlighter-rouge">web*</code> (Using Ted’s credentials),<li>If the server doesn’t respond, the script sends Ted an email informing him of the outage.</ul><p>Fortunately, <a href="https://github.com/dirkjanm/krbrelayx/blob/master/dnstool.py">dnstool.py</a> exists. With this tool, we can create a DNS record, name the record something to match the criteria like <code class="language-plaintext highlighter-rouge">webSlimicide</code>, resolve it to my TUN0 IP and capture Ted’s NTLMv2 hash with <code class="language-plaintext highlighter-rouge">Responder</code>.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_responder.png" alt="DNSTool Responder" title="DNSTool Responder" data-proofer-ignore> <em>dnstool.py // responder</em></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>dnstool.py parameters
---------------------
-u = username
-p = password
-a = action
-r = record name
-d = record data
-t = record type
</pre></table></code></div></div><p>The security on this box is incredible.<br /> By the time the script runs, the intruder will be long dead of old age.<br /> Eventually, we catch Ted’s NTLMv2 hash.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_responded.png" alt="Responded" title="Responded" data-proofer-ignore> <em>Ted.Graves NTLMv2 Hash</em></p><p>You can’t see it in that screenshot, but trust me, it’s there. Upon capturing this hash, we can head over to HashCat and see if we can crack it. Using <code class="language-plaintext highlighter-rouge">RockYou.txt</code>, the hash cracks almost instantly and we are left with a new set of credentials: <code class="language-plaintext highlighter-rouge">Ted.Graves:Mr.Teddy</code>.<br /></p><p>We have now compromised two accounts in this domain. Time to go see what new permissions are afforded to us courtesy of Ted Graves. Easiest way to do this is to call in the Bloodhound.</p><hr /><h1 id="bloodhound">Bloodhound</h1><p>Using Bloodhound-Python, we can authenticate into the domain and Bloodhound will collect all the information it can and bundle it into a nice little JSON file to be imported into Bloodhound’s GUI. For good measure, we’ll run Bloodhound-Python on both <code class="language-plaintext highlighter-rouge">Ted.Graves</code> and <code class="language-plaintext highlighter-rouge">Tiffany.Molina</code>.<br /><br /></p><p>After importing the information provided to us by Bloodhound-Python and analysing the permissions of our compromised users, we discover that <code class="language-plaintext highlighter-rouge">Ted.Graves</code> is a member of the IT Support group in the domain and as a member of that group, he consequentially has permissions to read the GMSA password of <code class="language-plaintext highlighter-rouge">SVC_INT</code>.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_bloodhound.png" alt="Bloodhound" title="Bloodhound" data-proofer-ignore> <em>ReadGMSAPassword</em></p><p>GMSA Accounts are automated service accounts necessary for the fulfilment of tasks in their respective domains, these accounts must also authenticate themselves when performing their tasks and so being able to read the GMSA’s password is great for us. We get a silver-ticket, not so great for the domain.</p><p>After searching for a tool which may be able to read this password for us, we come across a GitHub repository for <a href="https://github.com/micahvandeusen/gMSADumper">gMSADumper</a>. Running this tool, we’re given the password hash for <code class="language-plaintext highlighter-rouge">svc_int</code>:</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_svchash.png" alt="gMSADumper" title="gMSADumper" data-proofer-ignore> <em>svc_int</em></p><p>With the password hash of a service account, we can now use <code class="language-plaintext highlighter-rouge">GetST.py</code> from Impacket to generate a silver-ticket to impersonate <code class="language-plaintext highlighter-rouge">Administrator</code>. Doing this requires us to sync our system’s time to the server. In some cases like mine, if you are running a VirtualBox VM, you will first have to do:<br /> <code class="language-plaintext highlighter-rouge">sudo service virtualbox-guest-utils stop</code><br /> To prevent VirtualBox from automatically resetting your time. After stopping that service, you then run:<br /> <code class="language-plaintext highlighter-rouge">sudo ntpdate 10.10.10.248</code><br /> To sync up with the server.<br /><br /></p><p>With all that out of the way, we can generate our silver-ticket.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>python3 getST.py <span class="nt">-dc-ip</span> 10.10.10.248 <span class="nt">-spn</span> www/dc.intelligence.htb <span class="nt">-hashes</span> :a5fd76c71109b0b483abe309fbc92ccb <span class="nt">-impersonate</span> Administrator intelligence.htb/svc_int
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>-------------------------------------------------------------------
[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">getST.py</code> has saved our ticket to <code class="language-plaintext highlighter-rouge">Administrator.ccache</code>, we create the <code class="language-plaintext highlighter-rouge">KRB5CCNAME</code> environment variable, (which is typically used to authenticate service accounts) and point it towards our silver-ticket. We can then run Impacket’s <code class="language-plaintext highlighter-rouge">wmiexec.py</code> using Kerberos authentication with our new shiny silver-ticket and we successfully have logged into the domain as <code class="language-plaintext highlighter-rouge">Administrator</code></p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_silverticket.png" alt="Administrator" title="Administrator" data-proofer-ignore> <em>Administrator</em></p><p>Navigate to <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop</code> and claim the root flag.</p><p><img data-src="/assets/img/HackTheBox/Intelligence/htb_root.png" alt="Root" title="Root" data-proofer-ignore> <em>root.txt</em></p><h1>:)</h1></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/machines/'>Machines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >hackthebox</a> <a href="/tags/intelligence/" class="post-tag no-text-decoration" >intelligence</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active_directory</a> <a href="/tags/exiftool/" class="post-tag no-text-decoration" >exiftool</a> <a href="/tags/scripting/" class="post-tag no-text-decoration" >scripting</a> <a href="/tags/smb/" class="post-tag no-text-decoration" >smb</a> <a href="/tags/responder/" class="post-tag no-text-decoration" >responder</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >bloodhound</a> <a href="/tags/silver-ticket/" class="post-tag no-text-decoration" >silver_ticket</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox - Intelligence - Slimicide&amp;url=https://slimicide.github.io/posts/HackTheBox-Intelligence/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox - Intelligence - Slimicide&amp;u=https://slimicide.github.io/posts/HackTheBox-Intelligence/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://slimicide.github.io/posts/HackTheBox-Intelligence/&amp;text=HackTheBox - Intelligence - Slimicide" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HackTheBox-Templated/">HackTheBox - Templated</a><li><a href="/posts/HackTheBox-Forge/">HackTheBox - Forge</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/active-directory/">active_directory</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer-overflow</a> <a class="post-tag" href="/tags/evil-winrm/">evil-winrm</a> <a class="post-tag" href="/tags/ldap/">ldap</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HackTheBox-Resolute/"><div class="card-body"> <em class="timeago small" data-ts="1654048800" > 2022-06-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Resolute</h3><div class="text-muted small"><p> HackTheBox Resolute Resolute is a retired medium Active Directory machine on HackTheBox, expanding on my Active Directory experience from the previous machine Intelligence. Enumeration Initial...</p></div></div></a></div><div class="card"> <a href="/posts/HackTheBox-Cascade/"><div class="card-body"> <em class="timeago small" data-ts="1654210800" > 2022-06-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Cascade</h3><div class="text-muted small"><p> HackTheBox Cascade Cascade is a retired medium Active Directory machine on HackTheBox. Enumeration Like usual, we can start out by enumerating all the ports and do a more thorough scan of exis...</p></div></div></a></div><div class="card"> <a href="/posts/HackTheBox-Templated/"><div class="card-body"> <em class="timeago small" data-ts="1652477400" > 2022-05-13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Templated</h3><div class="text-muted small"><p> SSTI or Server-Side Template Injection is a vulnerability that always really confused me but at the same time, really interested me. Add those together and I went about finding out how it worked. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HackTheBox-Forge/" class="btn btn-outline-primary" prompt="Older"><p>HackTheBox - Forge</p></a> <a href="/posts/OWASP-Top-10/" class="btn btn-outline-primary" prompt="Newer"><p>OWASP Top 10 - OWASP Juice Shop</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/Slimicide_">Slimicide</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/active-directory/">active_directory</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/buffer-overflow/">buffer-overflow</a> <a class="post-tag" href="/tags/evil-winrm/">evil-winrm</a> <a class="post-tag" href="/tags/ldap/">ldap</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
